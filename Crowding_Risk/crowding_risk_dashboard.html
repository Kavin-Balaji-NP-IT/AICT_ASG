<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowding Risk Prediction - Scenario Simulator Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
        }

        .tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
        }

        .tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .mode-panel {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .mode-header {
            padding: 20px;
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }

        .today-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .future-header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .mode-content {
            padding: 25px;
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 14px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
            border: 2px solid #ecf0f1;
        }

        .radio-option:hover {
            background: #e8f4fd;
            border-color: #3498db;
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .radio-option.selected {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #ecf0f1;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .result-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .risk-score {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .risk-low { color: #27ae60; }
        .risk-medium { color: #f39c12; }
        .risk-high { color: #e74c3c; }

        .comparison-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .result-plot {
            text-align: center;
        }

        .result-plot img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .comparison-plot {
            text-align: center;
            margin-top: 30px;
        }

        .comparison-plot img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .controls-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .scenario-library {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .scenario-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #ecf0f1;
            transition: all 0.3s ease;
        }

        .scenario-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .scenario-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .scenario-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .scenario-settings {
            font-size: 0.9em;
            color: #95a5a6;
            margin-bottom: 15px;
            font-family: monospace;
        }

        .scenario-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }

        .network-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .network-structure {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .variable-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .variable-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ecf0f1;
        }

        .variable-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .variable-description {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .variable-values {
            font-size: 0.8em;
            color: #95a5a6;
            font-family: monospace;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
            color: #2c3e50;
        }

        .insights-list li:before {
            content: "üí°";
            margin-right: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .improvement-badge {
            display: inline-block;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin: 10px 0;
        }

        .insights-list li:before {
            content: "üí°";
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .comparison-view {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .controls-bar {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Crowding Risk Prediction</h1>
            <p>Scenario Simulator Dashboard - Changi Airport T5 Corridor Analysis</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('comparison')">Today vs Future Comparison</button>
                <button class="tab" onclick="showTab('scenarios')">Scenario Library</button>
                <button class="tab" onclick="showTab('network')">Network Analysis</button>
            </div>

            <!-- Comparison Tab -->
            <div id="comparison" class="tab-content active">
                <div class="controls-bar">
                    <button class="btn btn-primary" onclick="runPrediction()">üîÑ Update Prediction</button>
                    <button class="btn btn-secondary" onclick="syncSettings()">üîó Sync Today ‚Üí Future</button>
                    <button class="btn btn-secondary" onclick="resetAll()">‚Üª Reset All</button>
                    <button class="btn btn-success" onclick="exportResults()">üìä Export Results</button>
                </div>

                <div class="comparison-view">
                    <!-- Today Mode Panel -->
                    <div class="mode-panel">
                        <div class="mode-header today-header">
                            Today Mode (Current Network)
                        </div>
                        <div class="mode-content">
                            <div class="control-group">
                                <label class="control-label">Weather (W)</label>
                                <div class="radio-group" id="today-weather">
                                    <label class="radio-option">
                                        <input type="radio" name="today_weather" value="Clear" checked>
                                        <span>‚òÄÔ∏è Clear</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_weather" value="Rainy">
                                        <span>üåßÔ∏è Rainy</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_weather" value="Thunderstorms">
                                        <span>‚õàÔ∏è Thunderstorms</span>
                                    </label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Time of Day (T)</label>
                                <div class="radio-group" id="today-time">
                                    <label class="radio-option">
                                        <input type="radio" name="today_time" value="Morning" checked>
                                        <span>üåÖ Morning</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_time" value="Afternoon">
                                        <span>‚òÄÔ∏è Afternoon</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_time" value="Evening">
                                        <span>üåÜ Evening</span>
                                    </label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Day Type (D)</label>
                                <div class="radio-group" id="today-day">
                                    <label class="radio-option">
                                        <input type="radio" name="today_day" value="Weekday" checked>
                                        <span>üìÖ Weekday</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_day" value="Weekend">
                                        <span>üéâ Weekend</span>
                                    </label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Service Status (S)</label>
                                <div class="radio-group" id="today-service">
                                    <label class="radio-option">
                                        <input type="radio" name="today_service" value="Normal" checked>
                                        <span>‚úÖ Normal</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_service" value="Reduced">
                                        <span>‚ö†Ô∏è Reduced</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="today_service" value="Disrupted">
                                        <span>üö´ Disrupted</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Future Mode Panel -->
                    <div class="mode-panel">
                        <div class="mode-header future-header">
                            Future Mode (With TELe/CRL)
                        </div>
                        <div class="mode-content">
                            <div class="control-group">
                                <label class="control-label">Weather (W)</label>
                                <div class="radio-group" id="future-weather">
                                    <label class="radio-option">
                                        <input type="radio" name="future_weather" value="Clear" checked>
                                        <span>‚òÄÔ∏è Clear</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_weather" value="Rainy">
                                        <span>üåßÔ∏è Rainy</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_weather" value="Thunderstorms">
                                        <span>‚õàÔ∏è Thunderstorms</span>
                                    </label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Time of Day (T)</label>
                                <div class="radio-group" id="future-time">
                                    <label class="radio-option">
                                        <input type="radio" name="future_time" value="Morning" checked>
                                        <span>üåÖ Morning</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_time" value="Afternoon">
                                        <span>‚òÄÔ∏è Afternoon</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_time" value="Evening">
                                        <span>üåÜ Evening</span>
                                    </label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Day Type (D)</label>
                                <div class="radio-group" id="future-day">
                                    <label class="radio-option">
                                        <input type="radio" name="future_day" value="Weekday" checked>
                                        <span>üìÖ Weekday</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_day" value="Weekend">
                                        <span>üéâ Weekend</span>
                                    </label>
                                </div>
                            </div>

                            <div class="control-group">
                                <label class="control-label">Service Status (S)</label>
                                <div class="radio-group" id="future-service">
                                    <label class="radio-option">
                                        <input type="radio" name="future_service" value="Normal" checked>
                                        <span>‚úÖ Normal</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_service" value="Reduced">
                                        <span>‚ö†Ô∏è Reduced</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="future_service" value="Disrupted">
                                        <span>üö´ Disrupted</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="results-section">
                    <div class="results-grid">
                        <div class="result-panel">
                            <h3>Today Mode Results</h3>
                            <div class="chart-container">
                                <canvas id="todayChart"></canvas>
                            </div>
                            <div class="risk-score" id="todayRiskScore">Risk Score: 0.000</div>
                            <div id="todayDetails"></div>
                        </div>
                        
                        <div class="result-panel">
                            <h3>Future Mode Results</h3>
                            <div class="chart-container">
                                <canvas id="futureChart"></canvas>
                            </div>
                            <div class="risk-score" id="futureRiskScore">Risk Score: 0.000</div>
                            <div id="futureDetails"></div>
                        </div>
                    </div>

                    <div class="comparison-summary">
                        <h3>Comparison Analysis</h3>
                        <div id="improvementBadge" class="improvement-badge">
                            üìà 0.0% Improvement
                        </div>
                        <div id="comparisonDetails"></div>
                    </div>
                </div>
            </div>

            <!-- Scenarios Tab -->
            <div id="scenarios" class="tab-content">
                <h2>Predefined Scenario Library</h2>
                <p>Select from predefined scenarios to quickly test different conditions:</p>
                
                <div class="scenario-library" id="scenario-library">
                    <!-- Scenarios will be loaded here -->
                </div>
            </div>

            <!-- Network Tab -->
            <div id="network" class="tab-content">
                <div class="network-info">
                    <h2>Bayesian Network Structure</h2>
                    
                    <div class="network-structure">
                        <h3>Network Topology</h3>
                        <p><strong>W, T, D, M ‚Üí P ‚Üí C ‚Üê S ‚Üê M</strong></p>
                        <p>The network models how Weather (W), Time (T), Day Type (D), and Network Mode (M) influence Demand (P), which along with Service Status (S) determines Crowding Risk (C).</p>
                    </div>

                    <h3>Variables</h3>
                    <div class="variable-grid" id="variable-grid">
                        <!-- Variables will be loaded here -->
                    </div>

                    <h3>Key Insights</h3>
                    <ul class="insights-list" id="insights-list">
                        <!-- Insights will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Bayesian Network Implementation
        class BayesianNetwork {
            constructor() {
                this.domains = {
                    'W': ['Clear', 'Rainy', 'Thunderstorms'],
                    'T': ['Morning', 'Afternoon', 'Evening'],
                    'D': ['Weekday', 'Weekend'],
                    'M': ['Today', 'Future'],
                    'S': ['Normal', 'Reduced', 'Disrupted'],
                    'P': ['Low', 'Medium', 'High'],
                    'C': ['Low', 'Medium', 'High']
                };
                
                this.initializeCPTs();
            }

            initializeCPTs() {
                // P(W) - Weather probabilities
                this.cpts = {
                    'W': {
                        'Clear': 0.45,
                        'Rainy': 0.40,
                        'Thunderstorms': 0.15
                    },
                    
                    // P(T) - Time of Day probabilities
                    'T': {
                        'Morning': 0.33,
                        'Afternoon': 0.34,
                        'Evening': 0.33
                    },
                    
                    // P(D) - Day Type probabilities
                    'D': {
                        'Weekday': 5/7,
                        'Weekend': 2/7
                    },
                    
                    // P(M) - Network Mode
                    'M': {
                        'Today': 0.5,
                        'Future': 0.5
                    },
                    
                    // P(S|M) - Service Status given Network Mode
                    'S': {
                        'Today': {
                            'Normal': 0.70,
                            'Reduced': 0.20,
                            'Disrupted': 0.10
                        },
                        'Future': {
                            'Normal': 0.75,
                            'Reduced': 0.18,
                            'Disrupted': 0.07
                        }
                    }
                };

                // Initialize P(P|W,T,D,M) - Demand Proxy
                this.cpts['P'] = {};
                this.domains['W'].forEach(w => {
                    this.domains['T'].forEach(t => {
                        this.domains['D'].forEach(d => {
                            this.domains['M'].forEach(m => {
                                this.cpts['P'][`${w},${t},${d},${m}`] = this.calculateDemandProb(w, t, d, m);
                            });
                        });
                    });
                });

                // Initialize P(C|P,S,M) - Crowding Risk
                this.cpts['C'] = {};
                this.domains['P'].forEach(p => {
                    this.domains['S'].forEach(s => {
                        this.domains['M'].forEach(m => {
                            this.cpts['C'][`${p},${s},${m}`] = this.calculateCrowdingProb(p, s, m);
                        });
                    });
                });
            }
            
            calculateDemandProb(w, t, d, m) {
                let baseLow = 0.33, baseMed = 0.34, baseHigh = 0.33;
                
                // Time of Day effect
                if (t === 'Morning') {
                    baseLow = 0.15; baseMed = 0.35; baseHigh = 0.50;
                } else if (t === 'Afternoon') {
                    baseLow = 0.30; baseMed = 0.45; baseHigh = 0.25;
                } else { // Evening
                    baseLow = 0.20; baseMed = 0.35; baseHigh = 0.45;
                }
                
                // Day Type effect
                if (d === 'Weekday') {
                    baseHigh += 0.10;
                    baseLow -= 0.10;
                } else {
                    baseMed += 0.05;
                    baseHigh -= 0.05;
                }
                
                // Weather effect
                if (w === 'Rainy') {
                    baseLow += 0.05;
                    baseHigh -= 0.05;
                } else if (w === 'Thunderstorms') {
                    baseLow += 0.08;
                    baseMed += 0.02;
                    baseHigh -= 0.10;
                }
                
                // Normalize
                const total = baseLow + baseMed + baseHigh;
                return {
                    'Low': baseLow / total,
                    'Medium': baseMed / total,
                    'High': baseHigh / total
                };
            }

            calculateCrowdingProb(p, s, m) {
                let baseLow, baseMed, baseHigh;
                
                // Base crowding based on demand
                if (p === 'Low') {
                    baseLow = 0.70; baseMed = 0.25; baseHigh = 0.05;
                } else if (p === 'Medium') {
                    baseLow = 0.30; baseMed = 0.50; baseHigh = 0.20;
                } else { // High
                    baseLow = 0.10; baseMed = 0.35; baseHigh = 0.55;
                }
                
                // Service Status effect
                if (s === 'Reduced') {
                    baseHigh += 0.20;
                    baseMed += 0.10;
                    baseLow -= 0.30;
                } else if (s === 'Disrupted') {
                    baseHigh += 0.30;
                    baseMed += 0.05;
                    baseLow -= 0.35;
                }
                
                // Network Mode effect
                if (m === 'Future') {
                    baseHigh -= 0.15;
                    baseMed += 0.05;
                    baseLow += 0.10;
                }
                
                // Ensure non-negative and normalize
                baseLow = Math.max(0.01, baseLow);
                baseMed = Math.max(0.01, baseMed);
                baseHigh = Math.max(0.01, baseHigh);
                
                const total = baseLow + baseMed + baseHigh;
                return {
                    'Low': baseLow / total,
                    'Medium': baseMed / total,
                    'High': baseHigh / total
                };
            }

            inference(queryVar, evidence) {
                if (queryVar === 'C') {
                    return this.inferCrowding(evidence);
                } else if (queryVar === 'P') {
                    return this.inferDemand(evidence);
                }
                return null;
            }

            inferDemand(evidence) {
                const key = `${evidence.W},${evidence.T},${evidence.D},${evidence.M}`;
                return this.cpts['P'][key];
            }

            inferCrowding(evidence) {
                // First get demand distribution
                const demandDist = this.inferDemand(evidence);
                
                // Then calculate crowding for each demand level
                let crowdingDist = { 'Low': 0, 'Medium': 0, 'High': 0 };
                
                this.domains['P'].forEach(p => {
                    const key = `${p},${evidence.S},${evidence.M}`;
                    const crowdingGivenP = this.cpts['C'][key];
                    
                    this.domains['C'].forEach(c => {
                        crowdingDist[c] += demandDist[p] * crowdingGivenP[c];
                    });
                });
                
                return crowdingDist;
            }
        }

        // Global variables
        let bn = new BayesianNetwork();
        let todayChart = null;
        let futureChart = null;
        let currentResults = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initializing...');
            try {
                setupRadioButtons();
                console.log('Radio buttons set up');
                loadScenarios();
                console.log('Scenarios loaded');
                loadNetworkInfo();
                console.log('Network info loaded');
                runPrediction();
                console.log('Initial prediction run');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        function showTab(tabName) {
            console.log('showTab called with:', tabName);
            try {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab content
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('Activated tab:', tabName);
                } else {
                    console.error('Tab not found:', tabName);
                }
                
                // Add active class to the correct tab button
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.textContent.toLowerCase().includes(tabName) || 
                        (tabName === 'comparison' && tab.textContent.includes('Comparison')) ||
                        (tabName === 'scenarios' && tab.textContent.includes('Scenario')) ||
                        (tabName === 'network' && tab.textContent.includes('Network'))) {
                        tab.classList.add('active');
                    }
                });
            } catch (error) {
                console.error('Error in showTab:', error);
            }
        }

        function exportResults() {
            if (!currentResults) {
                alert('No results to export. Please run a prediction first.');
                return;
            }
            
            const data = getFormData();
            
            // Create CSV data
            const csvData = [
                ['Mode', 'Weather', 'Time', 'Day_Type', 'Service_Status', 'P_Low', 'P_Medium', 'P_High', 'Risk_Score'],
                [
                    'Today',
                    data.today.W,
                    data.today.T,
                    data.today.D,
                    data.today.S,
                    currentResults.today.Low.toFixed(4),
                    currentResults.today.Medium.toFixed(4),
                    currentResults.today.High.toFixed(4),
                    currentResults.todayRisk.toFixed(4)
                ],
                [
                    'Future',
                    data.future.W,
                    data.future.T,
                    data.future.D,
                    data.future.S,
                    currentResults.future.Low.toFixed(4),
                    currentResults.future.Medium.toFixed(4),
                    currentResults.future.High.toFixed(4),
                    currentResults.futureRisk.toFixed(4)
                ]
            ];
            
            // Convert to CSV string
            const csvString = csvData.map(row => row.join(',')).join('\n');
            
            // Download file
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crowding_risk_results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Results exported to CSV file!');
        }

        function setupRadioButtons() {
            // Add click handlers to radio button labels
            document.querySelectorAll('.radio-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    
                    // Update visual selection for the entire group
                    const group = this.parentElement;
                    group.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // Auto-update prediction
                    runPrediction();
                });
            });

            // Set initial selected states
            updateAllRadioVisuals();
        }

        function getFormData() {
            return {
                today: {
                    W: document.querySelector('input[name="today_weather"]:checked').value,
                    T: document.querySelector('input[name="today_time"]:checked').value,
                    D: document.querySelector('input[name="today_day"]:checked').value,
                    S: document.querySelector('input[name="today_service"]:checked').value,
                    M: 'Today'
                },
                future: {
                    W: document.querySelector('input[name="future_weather"]:checked').value,
                    T: document.querySelector('input[name="future_time"]:checked').value,
                    D: document.querySelector('input[name="future_day"]:checked').value,
                    S: document.querySelector('input[name="future_service"]:checked').value,
                    M: 'Future'
                }
            };
        }

        function calculateRiskScore(crowdingDist) {
            return crowdingDist.Low * 1 + crowdingDist.Medium * 2 + crowdingDist.High * 3;
        }

        function updateModeDisplay(mode, crowding, demand, riskScore, evidence) {
            // Update risk score
            const riskElement = document.getElementById(`${mode}RiskScore`);
            riskElement.textContent = `Risk Score: ${riskScore.toFixed(3)}`;
            
            // Set risk color
            riskElement.className = 'risk-score';
            if (riskScore < 1.5) {
                riskElement.classList.add('risk-low');
            } else if (riskScore < 2.5) {
                riskElement.classList.add('risk-medium');
            } else {
                riskElement.classList.add('risk-high');
            }
            
            // Update details
            const detailsElement = document.getElementById(`${mode}Details`);
            detailsElement.innerHTML = `
                <p><strong>Settings:</strong> ${evidence.W}, ${evidence.T}, ${evidence.D}, ${evidence.S}</p>
                <p><strong>P(High Risk):</strong> ${(crowding.High * 100).toFixed(1)}%</p>
                <p><strong>P(Medium Risk):</strong> ${(crowding.Medium * 100).toFixed(1)}%</p>
                <p><strong>P(Low Risk):</strong> ${(crowding.Low * 100).toFixed(1)}%</p>
            `;
            
            // Update chart
            updateChart(mode, crowding);
        }

        function updateChart(mode, crowding) {
            const ctx = document.getElementById(`${mode}Chart`).getContext('2d');
            
            // Destroy existing chart
            if (mode === 'today' && todayChart) {
                todayChart.destroy();
            } else if (mode === 'future' && futureChart) {
                futureChart.destroy();
            }
            
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
                    datasets: [{
                        data: [crowding.Low, crowding.Medium, crowding.High],
                        backgroundColor: ['#27ae60', '#f39c12', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            if (mode === 'today') {
                todayChart = chart;
            } else {
                futureChart = chart;
            }
        }

        function updateComparison(todayRisk, futureRisk) {
            const improvement = ((todayRisk - futureRisk) / todayRisk * 100);
            const badge = document.getElementById('improvementBadge');
            
            if (improvement >= 0) {
                badge.innerHTML = `üìà ${improvement.toFixed(1)}% Improvement`;
                badge.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
            } else {
                badge.innerHTML = `üìâ ${Math.abs(improvement).toFixed(1)}% Degradation`;
                badge.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            }
            
            const details = document.getElementById('comparisonDetails');
            details.innerHTML = `
                <p><strong>Today Risk Score:</strong> ${todayRisk.toFixed(3)}</p>
                <p><strong>Future Risk Score:</strong> ${futureRisk.toFixed(3)}</p>
                <p><strong>Risk Reduction:</strong> ${(todayRisk - futureRisk).toFixed(3)} points</p>
                <p><strong>TELe/CRL Impact:</strong> ${improvement >= 0 ? 'Positive' : 'Negative'}</p>
            `;
        }

        function runPrediction() {
            console.log('runPrediction called');
            try {
                const data = getFormData();
                console.log('Form data:', data);
                
                // Run inference for both modes
                const todayCrowding = bn.inference('C', data.today);
                const todayDemand = bn.inference('P', data.today);
                
                const futureCrowding = bn.inference('C', data.future);
                const futureDemand = bn.inference('P', data.future);
                
                // Calculate risk scores
                const todayRisk = calculateRiskScore(todayCrowding);
                const futureRisk = calculateRiskScore(futureCrowding);
                
                // Store results for export
                currentResults = {
                    today: todayCrowding,
                    future: futureCrowding,
                    todayRisk: todayRisk,
                    futureRisk: futureRisk
                };
                
                // Update displays
                updateModeDisplay('today', todayCrowding, todayDemand, todayRisk, data.today);
                updateModeDisplay('future', futureCrowding, futureDemand, futureRisk, data.future);
                updateComparison(todayRisk, futureRisk);
                
                console.log('Prediction completed successfully');
            } catch (error) {
                console.error('Error in runPrediction:', error);
                alert('Error running prediction: ' + error.message);
            }
        }

        function displayResults(result) {
            // Display plots
            document.getElementById('today-plot').src = 'data:image/png;base64,' + result.today.plot;
            document.getElementById('future-plot').src = 'data:image/png;base64,' + result.future.plot;
            document.getElementById('comparison-plot').src = 'data:image/png;base64,' + result.comparison_plot;
            
            // Display improvement info
            const improvementInfo = document.getElementById('improvement-info');
            const improvement = result.improvement.percent_improvement;
            const riskReduction = result.improvement.risk_reduction;
            
            improvementInfo.innerHTML = `
                <div class="improvement-badge">
                    ${improvement >= 0 ? 'üìà' : 'üìâ'} ${Math.abs(improvement).toFixed(1)}% ${improvement >= 0 ? 'Improvement' : 'Degradation'}
                </div>
                <p>Risk Score Reduction: ${riskReduction.toFixed(3)} points</p>
            `;
            
            // Show results
            document.getElementById('results').style.display = 'block';
        }

        function syncSettings() {
            console.log('syncSettings called');
            try {
                // Copy Today settings to Future
                const todayWeather = document.querySelector('input[name="today_weather"]:checked').value;
                const todayTime = document.querySelector('input[name="today_time"]:checked').value;
                const todayDay = document.querySelector('input[name="today_day"]:checked').value;
                const todayService = document.querySelector('input[name="today_service"]:checked').value;
                
                // Set Future settings
                document.querySelector(`input[name="future_weather"][value="${todayWeather}"]`).checked = true;
                document.querySelector(`input[name="future_time"][value="${todayTime}"]`).checked = true;
                document.querySelector(`input[name="future_day"][value="${todayDay}"]`).checked = true;
                document.querySelector(`input[name="future_service"][value="${todayService}"]`).checked = true;
                
                // Update visual selection for all radio buttons
                updateAllRadioVisuals();
                
                // Update prediction
                runPrediction();
                
                alert('Settings synced from Today to Future mode!');
            } catch (error) {
                console.error('Error in syncSettings:', error);
                alert('Error syncing settings: ' + error.message);
            }
        }

        function resetAll() {
            console.log('resetAll called');
            try {
                // Reset all to default values
                document.querySelectorAll('input[value="Clear"]').forEach(radio => radio.checked = true);
                document.querySelectorAll('input[value="Morning"]').forEach(radio => radio.checked = true);
                document.querySelectorAll('input[value="Weekday"]').forEach(radio => radio.checked = true);
                document.querySelectorAll('input[value="Normal"]').forEach(radio => radio.checked = true);
                
                // Update visual selection for all radio buttons
                updateAllRadioVisuals();
                
                // Update prediction
                runPrediction();
                
                alert('All settings reset to defaults!');
            } catch (error) {
                console.error('Error in resetAll:', error);
                alert('Error resetting settings: ' + error.message);
            }
        }

        function updateAllRadioVisuals() {
            // Remove all selected classes first
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to all checked radio buttons
            document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                const option = radio.closest('.radio-option');
                if (option) {
                    option.classList.add('selected');
                }
            });
        }

        function exportResults() {
            if (!currentResults) {
                alert('No results to export. Please run a prediction first.');
                return;
            }
            
            // Create CSV data
            const csvData = [
                ['Mode', 'Weather', 'Time', 'Day_Type', 'Service_Status', 'P_Low', 'P_Medium', 'P_High', 'Risk_Score'],
                [
                    'Today',
                    currentResults.today.evidence.W,
                    currentResults.today.evidence.T,
                    currentResults.today.evidence.D,
                    currentResults.today.evidence.S,
                    currentResults.today.crowding.Low.toFixed(4),
                    currentResults.today.crowding.Medium.toFixed(4),
                    currentResults.today.crowding.High.toFixed(4),
                    currentResults.today.risk_score.toFixed(4)
                ],
                [
                    'Future',
                    currentResults.future.evidence.W,
                    currentResults.future.evidence.T,
                    currentResults.future.evidence.D,
                    currentResults.future.evidence.S,
                    currentResults.future.crowding.Low.toFixed(4),
                    currentResults.future.crowding.Medium.toFixed(4),
                    currentResults.future.crowding.High.toFixed(4),
                    currentResults.future.risk_score.toFixed(4)
                ]
            ];
            
            // Convert to CSV string
            const csvString = csvData.map(row => row.join(',')).join('\n');
            
            // Download file
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'crowding_risk_results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Results exported to CSV file!');
        }

        function loadScenarios() {
            const scenarios = [
                {
                    id: 'morning_rush',
                    name: 'Morning Rush Hour - Clear Weather',
                    description: 'Peak morning commute with optimal conditions',
                    settings: { W: 'Clear', T: 'Morning', D: 'Weekday', S: 'Normal' }
                },
                {
                    id: 'evening_rain',
                    name: 'Evening Peak - Rainy Weather',
                    description: 'Evening rush with adverse weather conditions',
                    settings: { W: 'Rainy', T: 'Evening', D: 'Weekday', S: 'Normal' }
                },
                {
                    id: 'weekend_leisure',
                    name: 'Weekend Leisure Travel',
                    description: 'Typical weekend afternoon travel patterns',
                    settings: { W: 'Clear', T: 'Afternoon', D: 'Weekend', S: 'Normal' }
                },
                {
                    id: 'service_disruption',
                    name: 'Service Disruption - Peak Hour',
                    description: 'Major service disruption during morning peak',
                    settings: { W: 'Clear', T: 'Morning', D: 'Weekday', S: 'Disrupted' }
                },
                {
                    id: 'thunderstorm_reduced',
                    name: 'Thunderstorm + Reduced Service',
                    description: 'Severe weather with service impacts',
                    settings: { W: 'Thunderstorms', T: 'Evening', D: 'Weekday', S: 'Reduced' }
                },
                {
                    id: 'optimal',
                    name: 'Optimal Conditions',
                    description: 'Best case scenario with all favorable conditions',
                    settings: { W: 'Clear', T: 'Afternoon', D: 'Weekend', S: 'Normal' }
                }
            ];
            
            console.log('Loading scenarios:', scenarios);
            
            const container = document.getElementById('scenario-library');
            if (!container) {
                console.error('Scenario library container not found!');
                return;
            }
            
            container.innerHTML = '';
            
            scenarios.forEach(scenario => {
                const card = document.createElement('div');
                card.className = 'scenario-card';
                card.innerHTML = `
                    <div class="scenario-title">${scenario.name}</div>
                    <div class="scenario-description">${scenario.description}</div>
                    <div class="scenario-settings">Settings: ${JSON.stringify(scenario.settings)}</div>
                    <div class="scenario-buttons">
                        <button class="btn btn-secondary btn-small" onclick="loadScenario('today', '${scenario.id}')">
                            Load to Today
                        </button>
                        <button class="btn btn-success btn-small" onclick="loadScenario('future', '${scenario.id}')">
                            Load to Future
                        </button>
                        <button class="btn btn-primary btn-small" onclick="loadScenario('both', '${scenario.id}')">
                            Load to Both
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // Store scenarios for later use
            window.scenarios = scenarios;
            console.log('Scenarios loaded and stored:', window.scenarios);
        }

        function loadScenario(target, scenarioId) {
            console.log('Loading scenario:', scenarioId, 'to target:', target);
            console.log('Available scenarios:', window.scenarios);
            
            if (!window.scenarios) {
                console.error('Scenarios not loaded yet');
                alert('Scenarios not loaded yet. Please wait a moment and try again.');
                return;
            }
            
            const scenario = window.scenarios.find(s => s.id === scenarioId);
            if (!scenario) {
                console.error('Scenario not found:', scenarioId);
                alert('Scenario not found: ' + scenarioId);
                return;
            }
            
            console.log('Found scenario:', scenario);
            const settings = scenario.settings;
            
            try {
                if (target === 'today' || target === 'both') {
                    console.log('Setting today values:', settings);
                    document.querySelector(`input[name="today_weather"][value="${settings.W}"]`).checked = true;
                    document.querySelector(`input[name="today_time"][value="${settings.T}"]`).checked = true;
                    document.querySelector(`input[name="today_day"][value="${settings.D}"]`).checked = true;
                    document.querySelector(`input[name="today_service"][value="${settings.S}"]`).checked = true;
                }
                
                if (target === 'future' || target === 'both') {
                    console.log('Setting future values:', settings);
                    document.querySelector(`input[name="future_weather"][value="${settings.W}"]`).checked = true;
                    document.querySelector(`input[name="future_time"][value="${settings.T}"]`).checked = true;
                    document.querySelector(`input[name="future_day"][value="${settings.D}"]`).checked = true;
                    document.querySelector(`input[name="future_service"][value="${settings.S}"]`).checked = true;
                }
                
                // Update visual selection for all radio buttons
                updateAllRadioVisuals();
                
                // Update prediction
                runPrediction();
                
                // Switch to comparison tab
                showTab('comparison');
                
                alert(`Scenario "${scenario.name}" loaded to ${target} mode(s)!`);
                
            } catch (error) {
                console.error('Error loading scenario:', error);
                alert('Error loading scenario: ' + error.message);
            }
        }

        function loadNetworkInfo() {
            const networkData = {
                structure: {
                    variables: {
                        'W': {
                            name: 'Weather',
                            description: 'Weather conditions affecting travel',
                            values: ['Clear', 'Rainy', 'Thunderstorms'],
                            parents: [],
                            type: 'input'
                        },
                        'T': {
                            name: 'Time of Day',
                            description: 'Time period for analysis',
                            values: ['Morning', 'Afternoon', 'Evening'],
                            parents: [],
                            type: 'input'
                        },
                        'D': {
                            name: 'Day Type',
                            description: 'Weekday vs Weekend travel patterns',
                            values: ['Weekday', 'Weekend'],
                            parents: [],
                            type: 'input'
                        },
                        'M': {
                            name: 'Network Mode',
                            description: 'Current vs Future network infrastructure',
                            values: ['Today', 'Future'],
                            parents: [],
                            type: 'scenario'
                        },
                        'S': {
                            name: 'Service Status',
                            description: 'MRT service reliability level',
                            values: ['Normal', 'Reduced', 'Disrupted'],
                            parents: ['M'],
                            type: 'intermediate'
                        },
                        'P': {
                            name: 'Demand Proxy',
                            description: 'Passenger demand level',
                            values: ['Low', 'Medium', 'High'],
                            parents: ['W', 'T', 'D', 'M'],
                            type: 'intermediate'
                        },
                        'C': {
                            name: 'Crowding Risk',
                            description: 'Target prediction variable',
                            values: ['Low', 'Medium', 'High'],
                            parents: ['P', 'S', 'M'],
                            type: 'output'
                        }
                    }
                },
                insights: [
                    "Future network (TELe/CRL) provides 15-25% reduction in high crowding probability",
                    "Service disruptions significantly amplify crowding risk in both modes",
                    "Weather impacts are better mitigated in Future mode due to alternative routes",
                    "Morning and evening peaks show highest crowding risk",
                    "Weekend travel patterns generally have lower crowding risk"
                ]
            };
            
            // Load variables
            const variableGrid = document.getElementById('variable-grid');
            variableGrid.innerHTML = '';
            
            Object.entries(networkData.structure.variables).forEach(([key, variable]) => {
                const card = document.createElement('div');
                card.className = 'variable-card';
                card.innerHTML = `
                    <div class="variable-name">${key} - ${variable.name}</div>
                    <div class="variable-description">${variable.description}</div>
                    <div class="variable-values">Values: ${variable.values.join(', ')}</div>
                    <div class="variable-values">Parents: ${variable.parents.length > 0 ? variable.parents.join(', ') : 'None'}</div>
                `;
                variableGrid.appendChild(card);
            });
            
            // Load insights
            const insightsList = document.getElementById('insights-list');
            insightsList.innerHTML = '';
            
            networkData.insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
            });
        }
    </script>
</body>
</html>